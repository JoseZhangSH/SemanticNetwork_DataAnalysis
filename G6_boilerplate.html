<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Semantic Network VA</title>
</head>

<body>
    <!-- 引入 G6 -->
    <div id="container"></div>
</body>
<script src="https://gw.alipayobjects.com/os/lib/antv/g6/4.3.11/dist/g6.min.js"></script>


<script>
    const container = document.getElementById('container');
    const width = container.scrollWidth || 2560;
    const height = container.scrollHeight || 1440;

    G6.registerNode(
        'custom-node', {
            draw(cfg, group) {

                let r = cfg.size;
                //   if (isNumber(cfg.size)) {
                //     r = cfg.size / 2;
                //   } else if (isArray(cfg.size)) {
                //     r = cfg.size[0] / 2;
                //   }
                const style = cfg.style || {};
                // console.log(style);
                //   const colorSet = cfg.colorSet || colorSets[0];

                const keyShape = group.addShape('circle', {
                    attrs: {
                        ...style,
                        x: 0,
                        y: 0,
                        r,
                        fill: style.fill,
                        fillOpacity: style.fillOpacity,
                        stroke: style.stroke,
                        lineWidth: 2,
                        cursor: 'pointer',
                    },
                    name: 'custom-node-keyShape',
                });

                let labelStyle = {};
                if (cfg.labelCfg) {
                    labelStyle = Object.assign(labelStyle, cfg.labelCfg.style);
                }

                if (cfg.label) {
                    const text = cfg.label;
                    let labelStyle = {};
                    let refY = 0;
                    if (cfg.labelCfg) {
                        labelStyle = Object.assign(labelStyle, cfg.labelCfg.style);
                        refY += cfg.labelCfg.refY || 0;
                    }
                    // console.log(labelStyle);
                    let offsetY = 0;
                    const fontSize = labelStyle.fontSize < 8 ? 8 : labelStyle.fontSize;
                    const lineNum = cfg.labelLineNum || 1;
                    offsetY = lineNum * (fontSize || 12);
                    group.addShape('text', {
                        attrs: {
                            ...labelStyle,
                            text,
                            x: 0,
                            y: r + refY + offsetY + 5,
                            textAlign: 'center',
                            textBaseLine: 'alphabetic',
                            cursor: 'pointer',
                            fontSize,
                            fill: '#000',
                            opacity: 0.85,
                            fontWeight: 400,
                            // stroke: '#000',
                        },
                        name: 'text-shape',
                        className: 'text-shape',
                    });
                }

                if (cfg.semantic_feature == 1) {
                    // console.log("1");
                    group.addShape('circle', {
                        attrs: {
                            x: r - 0.414 * r + 2,
                            y: -r + 0.414 * r - 2,
                            r: 4,
                            fill: '#6DD400',
                            lineWidth: 0.5,
                            stroke: '#FFFFFF',
                        },
                        name: 'typeNode-tag-circle',
                    });
                };
                return keyShape;
            }
        },
        'aggregated-node',
    );

    const graph = new G6.Graph({
        container: 'container',
        width,
        height,
        modes: {
            default: ['drag-canvas', 'drag-node', 'zoom-canvas', 'lasso-select','activate-relations','click-select',
                // {
                //     type: 'tooltip',
                //     formatText(model) {
                //         return model.id;
                //     },
                //     offset: 10,
                // }
            ],
        },
        animate: true,
        layout: {
            type: 'forceAtlas2',
            kr: 40,
            // speed: 10,
            // gravity: 1,
            // maxIteration: 2000,
            // // for rendering after each iteration
            // tick: () => {
            // graph.refreshPositions()
            // },
            preventOverlap: true,
            workerEnabled: true, // 可选，开启 web-worker
            // gpuEnabled: true          // 可选，开启 GPU 并行计算，G6 4.0 支持
            // kr: 10,
        },
        defaultNode: {
            type: "custom-node",
            size: 10,
            style: {
                lineWidth: 0.5,
                // fillOpacity: 0.5,
            },
            labelCfg: {
                position: 'bottom',
                style: {
                    fill: '#666', // 节点标签文字颜色'
                    fontSize: 12,
                    fontFamily: 'Helvetica',
                    opacity: 1,
                },
            },
            icon: {
                show: true,
                // img: '...', 可更换为其他图片地址
                // text: '...', 使用 iconfont
                width: 10,
                height: 10,
            },
        },
        defaultEdge: {
            style: {
                opacity: 0.1,
                stroke: "grey",
                lineWidth: 0.3,
            }
        }
    });

    const main = async () => {
        // fetch('https://gw.alipayobjects.com/os/antvdemo/assets/data/relations.json')
        const response = await fetch('https://raw.githubusercontent.com/JoseZhangSH/SemanticNetwork_VA/main/data/04_Compare/ConceptNetwork_Experiment_G6.json?token=GHSAT0AAAAAABLZIDBA66KXLKLF7NLHOCR2YPX67OQ')
        // const response = await fetch('https://raw.githubusercontent.com/JoseZhangSH/SemanticNetwork_VA/main/data/02_Graph/ConceptNetwork_Complete.json?token=GHSAT0AAAAAABLZIDBASLDBH42PLRSPVNWQYP6ODPQ')
        const data = await response.json();
        const nodes = data.nodes;
        const edges = data.edges.map(edge => {
            if (edge.weight >=10){
                return edge
            }
        });

        // console.log(nodes);

        nodes.forEach(node => {
            if (!node.style) {
                node.style = {};
            }
            node.size = Math.pow((node.closeness_centrality * 10), 2) * 3;
            node.label = node.id;
            node.style.fillOpacity = node.picture_naming / 3;

            if (node.semantic_feature == 1) {
                console.log(node.style);
            }

            switch (node.maincategory) {
                case '动物': {
                    node.style.stroke = '#7262fd';
                    node.style.fill = '#7262fd';
                    break;
                }
                case '植物': {
                    node.style.stroke = '#F08BB4';
                    node.style.fill = '#F08BB4';
                    break;
                }
                case '食物': {
                    node.style.stroke = '#F6903D';
                    node.style.fill = '#F6903D';
                    break;
                }
                case '自然物': {
                    node.style.stroke = '#9661BC';
                    node.style.fill = '#9661BC';
                    break;
                }
                case '人造物': {
                    node.style.stroke = '#008685';
                    node.style.fill = '#008685';
                    break;
                }
                case '交通工具': {
                    node.style.stroke = '#5B8FF9';
                    node.style.fill = '#5B8FF9';
                    break;
                }
            }
        })


        // To Do:
        // 自定义节点
        // 是否做过语义特征分析 - 状态标签
        // capture click interaction and output selected node id
        // search in the database
        // losso select data and output selected nodes id
        // query subgraph
        // visualize as a matrix

        // Legend


        graph.data(data); // 加载数据
        graph.render(); // 渲染
        graph.on('node:click', evt => {
            console.log(evt.item.getModel().id);
        });
        graph.on('nodeselectchange', evt => {
            var selection = []
            evt.selectedItems.nodes.forEach(item => {

                selection.push(item.getModel().id);
            })
            console.log(selection);
        });
    }

    function refreshDragedNodePosition(e) {
        const model = e.item.get('model');
        model.fx = e.x;
        model.fy = e.y;
        model.x = e.x;
        model.y = e.y;
    }

    main();
</script>

</html>